# ************************************
# Managed by Puppet
# ************************************

<VirtualHost *:80>
    ServerName <%= @vhost_name %>
    DocumentRoot <%= @docroot %>

    LogLevel warn
    ErrorLog /var/log/apache2/<%= @vhost_name %>_error.log
    CustomLog /var/log/apache2/<%= @vhost_name %>_access.log combined
    ServerSignature Off

    <Directory <%= @docroot %>>
        Options Indexes FollowSymLinks MultiViews
        AllowOverride None
        AllowOverrideList Redirect RedirectMatch
        Satisfy Any
        Require all granted
    </Directory>

    Redirect permanent / https://<%= @vhost_name %>/
</VirtualHost>

<VirtualHost *:443>
    ServerName <%= @vhost_name %>
    DocumentRoot <%= @docroot %>

    SSLEngine on
    SSLProtocol All -SSLv2 -SSLv3
    SSLCipherSuite ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!AES256:!aNULL:!eNULL:!MD5:!DSS:!PSK:!SRP
    SSLHonorCipherOrder on
    SSLCertificateFile <%= @cert_file %>
    SSLCertificateKeyFile <%= @key_file %>

    LogLevel warn
    ErrorLog /var/log/apache2/ssl-<%= @vhost_name %>_error.log
    CustomLog /var/log/apache2/ssl-<%= @vhost_name %>_access.log combined
    ServerSignature Off

    <Directory <%= @docroot %>>
        Options Indexes FollowSymLinks MultiViews
        AllowOverride None
        AllowOverrideList Redirect RedirectMatch
        Satisfy Any
        Require all granted
    </Directory>

    <Directory /usr/local/lib/python2.7/dist-packages/os_loganalyze>
        <Files wsgi.py>
            Require all granted
        </Files>
    </Directory>
    RewriteEngine On
    RewriteRule ^/(.*\.txt\.gz)$ /htmlify/$1 [QSA,L,PT]
    SetEnv OS_LOGANALYZE_ROOT_PATH <%= @docroot %>
    WSGIDaemonProcess <%= @vhost_name %> user=www-data group=www-data processes=2 threads=10
    WSGIProcessGroup <%= @vhost_name %>
    WSGIScriptAlias /htmlify /usr/local/lib/python2.7/dist-packages/os_loganalyze/wsgi.py

    # Encoding for gzip files
    <FilesMatch \.html\.gz$>
        ForceType text/html
        AddDefaultCharset UTF-8
        AddEncoding x-gzip gz
    </FilesMatch>
    <FilesMatch \.css\.gz$>
        ForceType text/css
        AddDefaultCharset UTF-8
        AddEncoding x-gzip gz
    </FilesMatch>
    <FilesMatch \.js\.gz$>
        ForceType text/javascript
        AddDefaultCharset UTF-8
        AddEncoding x-gzip gz
    </FilesMatch>
    <FilesMatch \.ttf\.gz$>
        ForceType application/x-font-ttf
        AddEncoding x-gzip gz
    </FilesMatch>
    <FilesMatch \.svg\.gz$>
        ForceType image/svg+xml
        AddEncoding x-gzip gz
    </FilesMatch>
    <FilesMatch \.json\.gz$>
        ForceType application/json
        AddEncoding x-gzip gz
    </FilesMatch>
    <FilesMatch \.txt\.gz$>
        ForceType application/json
        AddEncoding x-gzip gz
    </FilesMatch>
    <FilesMatch \.css$>
        # mod_mime_magic is sometimes passing css files as asm sources
        # e.g css files generated by coverage reports
        ForceType text/css
    </FilesMatch>
</VirtualHost>
